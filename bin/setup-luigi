#!/bin/bash

# Luigi Knowledge Extractor Setup Script
# This script helps you get the application running after configuring Supabase

set -e

echo "ğŸš€ Luigi Knowledge Extractor Setup"
echo "=================================="
echo ""

# Check if .env file exists
if [ ! -f .env ]; then
    echo "âŒ .env file not found!"
    echo "ğŸ“‹ Please copy .env.example to .env and configure your credentials:"
    echo "   cp .env.example .env"
    echo ""
    echo "ğŸ“– Then follow the Supabase setup guide: SUPABASE_SETUP.md"
    exit 1
fi

# Check if essential environment variables are set
echo "ğŸ” Checking environment configuration..."

check_env_var() {
    local var_name=$1
    local var_value=$(grep "^${var_name}=" .env | cut -d'=' -f2-)
    
    if [[ -z "$var_value" || "$var_value" == *"your_"* ]]; then
        echo "âŒ $var_name not configured in .env"
        return 1
    else
        echo "âœ… $var_name configured"
        return 0
    fi
}

config_ok=true

check_env_var "DATABASE_URL" || config_ok=false
check_env_var "SUPABASE_URL" || config_ok=false
check_env_var "SUPABASE_ANON_KEY" || config_ok=false
check_env_var "OPENAI_API_KEY" || config_ok=false

if [ "$config_ok" = false ]; then
    echo ""
    echo "âŒ Environment configuration incomplete!"
    echo "ğŸ“– Please follow the setup guide: SUPABASE_SETUP.md"
    exit 1
fi

echo ""
echo "âœ… Environment configuration looks good!"
echo ""

# Stop any running containers
echo "ğŸ›‘ Stopping any existing containers..."
docker-compose down

# Start supporting services
echo "ğŸ”„ Starting Redis and Neo4j..."
docker-compose up -d redis neo4j

# Wait a moment for services to start
echo "â³ Waiting for services to initialize..."
sleep 5

# Build and start the main application
echo "ğŸ—ï¸  Building Luigi application..."
docker-compose build luigi-app

echo "ğŸš€ Starting Luigi application..."
docker-compose up -d luigi-app

# Wait for application to start
echo "â³ Waiting for application to start..."
sleep 10

# Run database migrations
echo "ğŸ“Š Running database migrations..."
if docker-compose exec -T luigi-app bundle exec rails db:migrate; then
    echo "âœ… Migrations completed successfully!"
else
    echo "âŒ Migration failed! Check your DATABASE_URL configuration."
    echo "ğŸ“– See SUPABASE_SETUP.md for help"
    exit 1
fi

# Initialize Luigi expert
echo "ğŸ‘¨â€ğŸ”§ Initializing Luigi expert..."
if docker-compose exec -T luigi-app bundle exec rails runner "LuigiExpert.luigi"; then
    echo "âœ… Luigi expert initialized!"
else
    echo "âŒ Luigi expert initialization failed!"
    exit 1
fi

# Check health
echo "ğŸ¥ Running health checks..."
echo "â³ Waiting for application to be ready..."
sleep 5

# Test the health endpoint
if curl -f -s http://localhost:3333/health > /dev/null 2>&1; then
    echo "âœ… Application health check passed!"
else
    echo "âš ï¸  Application may still be starting. Check manually at:"
    echo "   http://localhost:3333/health"
fi

echo ""
echo "ğŸ‰ Setup completed!"
echo ""
echo "ğŸ“± Your Luigi Knowledge Extractor is ready:"
echo "   ğŸŒ Web Interface: http://localhost:3333"
echo "   ğŸ¥ Health Check:  http://localhost:3333/health" 
echo "   ğŸ“Š Neo4j Browser: http://localhost:7475 (user: neo4j, pass: password)"
echo ""
echo "ğŸ“– To view logs:"
echo "   docker-compose logs -f luigi-app"
echo ""
echo "ğŸ›‘ To stop everything:"
echo "   docker-compose down"
echo ""
echo "ğŸ¯ Ready to extract Luigi's construction wisdom!"