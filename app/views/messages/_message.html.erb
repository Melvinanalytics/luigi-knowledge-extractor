<% cache message do %>
  <div class="flex <%= message.message_type == 'user' ? 'justify-end' : 'justify-start' %> mb-6" 
       data-message-id="<%= message.id %>">
    <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl message-<%= message.message_type %>">
      
      <!-- Message Content -->
      <div class="text-sm text-white whitespace-pre-wrap">
        <%= simple_format(message.content) %>
      </div>
      
      <!-- Knowledge Extraction Info (for assistant messages) -->
      <% if message.assistant_message? && message.confidence_score && message.confidence_score > 0 %>
        <div class="mt-3 p-3 bg-white/10 rounded-lg">
          <div class="text-xs text-blue-200 mb-2">
            ✅ <%= message.entities_extracted %> neue Konzepte erkannt 
            (<%= message.confidence_percentage %>% Sicherheit)
          </div>
          
          <% if message.processing_time_ms > 0 %>
            <div class="text-xs text-blue-300">
              ⏱️ Verarbeitet in <%= message.processing_time_formatted %>
            </div>
          <% end %>
          
          <!-- Follow-up Questions -->
          <% if message.follow_up_questions.any? %>
            <div class="mt-2 pt-2 border-t border-white/20">
              <div class="text-xs text-blue-200 mb-1">💭 Mögliche Nachfragen:</div>
              <% message.follow_up_questions.first(2).each do |question| %>
                <button class="block w-full text-left text-xs text-blue-300 hover:text-white p-1 rounded hover:bg-white/10 transition-colors"
                        data-controller="question-suggester"
                        data-action="click->question-suggester#selectQuestion"
                        data-question="<%= question %>">
                  "💬 <%= question %>"
                </button>
              <% end %>
            </div>
          <% end %>
          
          <!-- Concepts Found -->
          <% if message.concepts_found.any? %>
            <div class="mt-2 pt-2 border-t border-white/20">
              <div class="text-xs text-blue-200 mb-1">🔍 Erkannte Konzepte:</div>
              <div class="flex flex-wrap gap-1">
                <% message.concepts_found.first(4).each do |concept| %>
                  <span class="inline-block px-2 py-1 bg-blue-500/30 text-blue-200 text-xs rounded-full">
                    <%= concept %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <!-- Transcription Info (for voice messages) -->
      <% if message.metadata['source'] == 'whisper_api' %>
        <div class="mt-2 p-2 bg-purple-500/20 rounded-lg">
          <div class="text-xs text-purple-200 flex items-center space-x-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2a3 3 0 00-3 3v6a3 3 0 006 0V5a3 3 0 00-3-3zM19 10v1a7 7 0 01-14 0v-1a1 1 0 012 0v1a5 5 0 0010 0v-1a1 1 0 012 0zM12 15a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z"/>
            </svg>
            <span>Spracheingabe • <%= message.metadata['word_count'] %> Wörter</span>
            <% if message.metadata['transcription_confidence'] %>
              <span>• <%= (message.metadata['transcription_confidence'] * 100).round %>% genau</span>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <!-- Timestamp -->
      <div class="text-xs opacity-60 mt-2 flex items-center justify-between">
        <span><%= time_tag message.created_at, message.created_at.strftime('%H:%M:%S') %></span>
        
        <!-- Message Type Indicator -->
        <% if message.system_message? %>
          <span class="text-yellow-300">System</span>
        <% elsif message.assistant_message? %>
          <span class="text-blue-300">Luigi AI</span>
        <% else %>
          <span class="text-green-300">Du</span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>